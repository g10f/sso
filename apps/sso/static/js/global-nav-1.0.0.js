// Generated by CoffeeScript 1.7.1

/*
<ul class="nav navbar-nav" id="user_apps" data-user-apps-url="#{ user-apps-url }" data-app-uuid="" data-logout-url=""></ul>
 */

(function() {
  var add_thumbnail, add_user_apps_to_navbar, get_app_item, get_text;

  $(function() {
    var app_uuid, logout_url, user_apps, user_apps_url;
    user_apps = $('#user_apps');
    if (user_apps.length > 0) {
      user_apps_url = user_apps.data("user-apps-url");
      app_uuid = user_apps.data("app-uuid");
      logout_url = user_apps.data("logout-url");
      return add_user_apps_to_navbar(user_apps_url, app_uuid, logout_url);
    }
  });

  get_app_item = function(application, app_uuid) {
    var css_class;
    css_class = app_uuid && application.uuid === app_uuid ? "active" : "";
    return "<li class=\"" + css_class + "\"><a href=\"" + application.links.app.href + "\">" + application.links.app.title + "</a></li>";
  };

  add_thumbnail = function(data) {
    if (data.picture_30x30) {
      return $(".navbar i.icon-user").replaceWith("<img class=\"icon-user\" height=\"30\" alt=\"\" src=\"" + data.picture_30x30 + "\">");
    }
  };

  get_text = function(data, key) {
    if (data.text && data.text[key]) {
      return data.text[key];
    } else {
      return key;
    }
  };

  add_user_apps_to_navbar = function(user_app_url, app_uuid, logout_url) {
    var request;
    request = $.ajax({
      url: user_app_url,
      dataType: "jsonp",
      ifModified: true,
      jsonpCallback: 'user_apps',
      cache: true
    });
    return request.done(function(data) {
      var applications, html, i, items, more, subitems, thumbnail, _i, _j, _ref;
      if (data.error && data.code === 401) {
        if (logout_url) {
          return $(location).attr('href', logout_url);
        }
      } else {
        items = [];
        applications = data.applications.filter(function(application) {
          return application.links.app.global_navigation;
        });
        more = get_text(data, 'More');
        if (applications.length < 4) {
          $.each(applications, function(idx, application) {
            return items.push(get_app_item(application, app_uuid));
          });
        } else {
          for (i = _i = 0; _i <= 2; i = ++_i) {
            items.push(get_app_item(applications[i], app_uuid));
          }
          subitems = ["<li class=\"dropdown\"><a href=\"#\" class=\"dropdown-toggle\" data-toggle=\"dropdown\">" + more + " <b class=\"caret\"></b></a><ul class=\"dropdown-menu\">"];
          for (i = _j = 3, _ref = applications.length - 1; 3 <= _ref ? _j <= _ref : _j >= _ref; i = 3 <= _ref ? ++_j : --_j) {
            subitems.push(get_app_item(applications[i], app_uuid));
          }
          subitems.push("</ul></li>");
          items.push(subitems.join(''));
        }
        $('#user_apps').html(items.join(''));
        if (data.links) {
          if (data.links.picture_30x30) {
            thumbnail = "<img class=\"icon-user\" height=\"30\" alt=\"\" src=\"" + data.links.picture_30x30.href + "\">";
          } else {
            thumbnail = "<i class=\"glyphicon glyphicon-user icon-user\"></i>";
          }
          html = "<a href=\"" + data.links.profile.href + "\">" + thumbnail + " " + data.full_name + "</a>";
          return $('#user-profile').html(html);
        }
      }
    });
  };

}).call(this);
